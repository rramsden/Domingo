<html>
<head>
	<script src="../src/inheritance.js"></script>
	<script src="../src/websocket/swfobject.js"></script>
	<script src="../src/websocket/FABridge.js"></script>
	<script src="../src/websocket/web_socket.js"></script>
	<script src="../src/domingo.js"></script>
	<script src="../src/log.js"></script>
	<script src="../src/global.js"></script>
	<script src="../src/game.js"></script>
	<script src="../src/state.js"></script>
	<script src="../src/object.js"></script>
	<script src="../src/sprite.js"></script>
	<script src="../src/camera.js"></script>
	<script src="../src/tilemap.js"></script>
	<script src="../src/network.js"></script>
	<script src="../src/resource.js"></script>
	<script src="../src/text.js"></script>
	<script src="../src/audio.js"></script>
	<script src="../src/layer.js"></script>
	<style type="text/css">
		body {
			background: black;
			margin: auto;
			padding: auto;
			text-align: center;
		}
	</style>
	<meta name="viewport" content="initial-scale=1.0, width=device-width, height=device-height, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>
<body style="vertical-align: middle;">
	<div id="game" style="width: 100%; height: 100%; display: table;"></div>
	
	<script type="text/javascript">

		var Player = Class.extend(Domingo.Sprite, {
			initialize : function(x, y) {
				this.parent(x, y, 25, 25, "resource/character.png");
				this.setScale(64,64);
				this.solid = true;
				
				this.addAnimation({
					up:    { frames: [3,4], framerate: 10 },
					down:  { frames: [1,2], framerate: 10 },
					left:  { frames: [5,6], framerate: 10 },
					right: { frames: [7,8], framerate: 10 },
					die:   { frames: [9], framerate: 10 }
				});
				
				this.play("down")
			},
			
			update : function(layers) {
				if (this.direction["up"] == 1) {
					this.play("up")
					this.y -= (this.checkCollision(layers) ? (-this.velocity.y) : this.velocity.y);
				}
				if (this.direction["left"] == 1) {
					this.play("left")
					this.x -= (this.checkCollision(layers) ? (-this.velocity.x) : this.velocity.x);
				}
				if (this.direction["right"] == 1) {
					this.play("right")
					this.x += (this.checkCollision(layers) ? (-this.velocity.x) : this.velocity.x);
				}
				if (this.direction["down"] == 1) {
					this.play("down")
					this.y += (this.checkCollision(layers) ? (-this.velocity.y) : this.velocity.y);
				}
				this.reset();			
				this.parent(layers);
			}
		});
	
		var PlayState = Class.extend(Domingo.State, {
			initialize : function() {
				this.parent();

				var mapData = [
					[12,12,12,12,12,12,12,12,12,13,54,54],
					[12,12,12,12,12,12,12,12,12,13,54,54],
					[12,12,12,12,12,12,22,24,12,13,54,54],
					[12,12,12,14,12,12,36,38,12,13,54,54],
					[12,12,1 ,9 ,3 ,12,12,12,12,13,54,54],
					[12,35,9 ,9 ,9 ,42,12,12,12,13,54,54],
					[12,12,15,9 ,17,12,14,12,12,13,54,54],
					[12,12,12,21,12,12,7 ,12,12,13,54,54],
					[12,12,12,12,12,12,7 ,12,12,13,54,54],
					[12,12,12,12,12,12,15,28,28,28,54,54],
					[12,12,12,12,12,12,12,12,12,13,54,54],
					[19,19,19,19,19,19,19,19,19,20,54,54],
					[54,54,54,54,54,54,54,54,54,54,54,54],
					[54,54,54,54,54,54,54,54,54,54,54,54]
				];
				var map = new Domingo.TileMap("resource/tileset.png", 32, 32, mapData);
				map.setTileScale(64, 64);
				
				var font = new Domingo.Text(120, 2, "Domingo HTML5 engine",10,10,"white");
				
				var bglayer = this.createLayer("background")
				var sprites = this.createLayer("sprites")
				var hud = this.createLayer("hud")
				var player = new Player(0, 0);
				
				bglayer.push(map)
				hud.push(font);

				Domingo.Network.callback("connect", function(data) {
					Domingo.Camera.follow(player);
					Domingo.Controller = player;
					sprites.push(player);
				});
	
				Domingo.Network.callback("join", function(data) {
					var player = new Player(data.x, data.y);
					sprites.push(player, "player_" + data.id);
				});

				Domingo.Network.callback("move", function(data) {
					var player = sprites.get("player_" + data.id);
					player.x = data.x;
					player.y = data.y;
					player.direction[data.direction] = 1;
				});

				Domingo.Network.callback("disconnect", function(data) {
					sprites.remove("player_" + data.id);
				});

				//Domingo.Audio.loadSound("resource/shining2_town.ogg");
				//Domingo.Audio.play("resource/shining2_town.ogg",true, 0.1);
			}
		});

		var Game = new Domingo.Game(640,480,'game');
		Game.loadState(PlayState);

	</script>
</body>
</html>
